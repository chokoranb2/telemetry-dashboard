<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telemetry Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 6px 18px rgba(17,24,39,0.08);
      --radius: 16px;
      --pad: 18px;
      --primary:#2563eb;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      margin: 8px 0 14px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    h1{
      font-size: 22px;
      margin:0;
      letter-spacing:0.2px;
    }
    .subtitle{
      font-size: 12px;
      color: var(--muted);
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      background: rgba(255,255,255,0.65);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      backdrop-filter: blur(6px);
      margin-bottom: 14px;
    }
    .toolbar-left, .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
    }

    label{
      display:flex;
      gap: 8px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    select{
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      color: var(--text);
      min-width: 180px;
      outline: none;
    }

    .chips{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      transition: 0.15s;
    }
    .chip:hover{ transform: translateY(-1px); }
    .chip.active{
      border-color: rgba(37,99,235,0.35);
      background: rgba(37,99,235,0.10);
      color: var(--primary);
      font-weight: 700;
    }

    .btn{
      border: 1px solid var(--line);
      background:#fff;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 12px;
      transition:0.15s;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      border-color: rgba(37,99,235,0.35);
      background: rgba(37,99,235,0.10);
      color: var(--primary);
      font-weight: 700;
    }

    .status{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items: start;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }

    .card-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .card-title h3{
      margin:0;
      font-size: 14px;
      letter-spacing:0.2px;
    }
    .badge{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: #fff;
    }

    .kpi{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 8px;
    }
    .kpi-value{
      display:flex;
      align-items: baseline;
      gap: 10px;
      line-height:1;
    }
    .kpi-num{
      font-size: 44px;
      font-weight: 800;
      letter-spacing: 0.4px;
    }
    .kpi-unit{
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    .kpi-meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .kpi-quality{
      display:inline-flex;
      width: fit-content;
      gap: 8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .dot{
      width: 9px;
      height: 9px;
      border-radius: 50%;
      display:inline-block;
      background: #9ca3af; /* default */
    }
    .dot.ok{ background:#16a34a; }
    .dot.ng{ background:#dc2626; }

    .chart-wrap{
      height: 360px;
    }

    footer{
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      select{ min-width: 220px; }
      .chart-wrap{ height: 320px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Telemetry Dashboard</h1>
        <div class="subtitle">Latest value & trend from Supabase (Chart.js) — shared via SharePoint link</div>
      </div>
      <div class="status" id="status">-</div>
    </header>

    <div class="toolbar">
      <div class="toolbar-left">
        <label>
          Device
          <select id="deviceSelect"></select>
        </label>

        <div class="chips" aria-label="range">
          <button class="chip" id="btn1h"  type="button" onclick="setRange(1)">1h</button>
          <button class="chip" id="btn6h"  type="button" onclick="setRange(6)">6h</button>
          <button class="chip" id="btn24h" type="button" onclick="setRange(24)">24h</button>
        </div>
      </div>

      <div class="toolbar-right">
        <button class="btn primary" type="button" onclick="refreshAll()">更新</button>
      </div>
    </div>

    <div class="grid">
      <!-- KPI -->
      <section class="card">
        <div class="card-title">
          <h3>最新値</h3>
          <span class="badge" id="kpiBadge">-</span>
        </div>

        <div class="kpi">
          <div class="kpi-value">
            <div class="kpi-num" id="latestNum">-</div>
            <div class="kpi-unit" id="latestUnit"> </div>
          </div>

          <div class="kpi-meta">
            <div id="latestTime">-</div>
            <div class="kpi-quality">
              <span class="dot" id="qDot"></span>
              <span>Quality:</span>
              <strong id="latestQuality">-</strong>
            </div>
          </div>
        </div>
      </section>

      <!-- Trend -->
      <section class="card">
        <div class="card-title">
          <h3 id="trendTitle">トレンド</h3>
          <span class="badge" id="trendBadge">-</span>
        </div>
        <div class="chart-wrap">
          <canvas id="trendChart"></canvas>
        </div>
      </section>
    </div>

    <footer>
      自動更新: <span id="autoInfo">-</span>
    </footer>
  </div>

<script>
/* ===================== 設定（ここだけ合わせてください） ===================== */
const SUPABASE_URL = "https://modjfdtgkxkvxdcffcyx.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_IHKNNw2t8AWE2yKyPX8sSA_W11U4wHU";
const TABLE = "telemetry";

const COL_TS = "ts";
const COL_DEVICE = "device";
const COL_VALUE = "value";
const COL_UNIT = "unit";
const COL_QUALITY = "quality";

// ① 自動更新（20分）
const AUTO_REFRESH_MINUTES = 20;
const AUTO_REFRESH_MS = AUTO_REFRESH_MINUTES * 60 * 1000;

// ② 初期表示レンジ（hours）
let rangeHours = 24;
/* =========================================================================== */

const REST_BASE = `${SUPABASE_URL}/rest/v1/${TABLE}`;

let chart;

/* ---------- util ---------- */
function headers() {
  return {
    apikey: SUPABASE_ANON_KEY,
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    "Content-Type": "application/json"
  };
}

function isoHoursAgo(hours) {
  return new Date(Date.now() - hours * 3600 * 1000).toISOString();
}

function fmtDateTime(iso) {
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return iso;
  // ローカル表示（日本時間）
  return d.toLocaleString();
}

function setStatus(msg) {
  document.getElementById("status").textContent = msg;
}

/* ---------- Supabase fetch ---------- */
async function fetchDevices() {
  const url = `${REST_BASE}?select=${COL_DEVICE}&limit=10000`;
  const res = await fetch(url, { headers: headers() });
  if (!res.ok) throw new Error(`devices fetch failed: ${res.status} ${await res.text()}`);
  const rows = await res.json();
  return [...new Set(rows.map(r => r[COL_DEVICE]).filter(Boolean))].sort();
}

async function fetchLatest(device) {
  const url =
    `${REST_BASE}?select=${COL_TS},${COL_VALUE},${COL_UNIT},${COL_QUALITY}` +
    `&${COL_DEVICE}=eq.${encodeURIComponent(device)}` +
    `&order=${COL_TS}.desc&limit=1`;

  const res = await fetch(url, { headers: headers() });
  if (!res.ok) throw new Error(`latest fetch failed: ${res.status} ${await res.text()}`);
  const rows = await res.json();
  return rows[0] || null;
}

async function fetchTrend(device) {
  const from = isoHoursAgo(rangeHours);
  const url =
    `${REST_BASE}?select=${COL_TS},${COL_VALUE}` +
    `&${COL_DEVICE}=eq.${encodeURIComponent(device)}` +
    `&${COL_TS}=gte.${encodeURIComponent(from)}` +
    `&order=${COL_TS}.asc`;

  const res = await fetch(url, { headers: headers() });
  if (!res.ok) throw new Error(`trend fetch failed: ${res.status} ${await res.text()}`);
  return await res.json();
}

/* ---------- render ---------- */
function setQuality(q) {
  const dot = document.getElementById("qDot");
  dot.classList.remove("ok","ng");
  if ((q || "").toUpperCase() === "OK") dot.classList.add("ok");
  else if ((q || "").toUpperCase() === "NG") dot.classList.add("ng");
}

function renderLatest(rec) {
  if (!rec) return;

  const v = rec[COL_VALUE];
  const u = rec[COL_UNIT] || "";
  const q = rec[COL_QUALITY] || "";
  const ts = rec[COL_TS];

  document.getElementById("latestNum").textContent = (v ?? "-");
  document.getElementById("latestUnit").textContent = u;
  document.getElementById("latestTime").textContent = `時刻: ${fmtDateTime(ts)}`;
  document.getElementById("latestQuality").textContent = q || "-";
  setQuality(q);

  // バッジ（例：受信時刻）
  document.getElementById("kpiBadge").textContent = `range ${rangeHours}h`;
}

function renderChart(rows) {
  const labels = rows.map(r => {
    const d = new Date(r[COL_TS]);
    if (Number.isNaN(d.getTime())) return r[COL_TS];
    return d.toLocaleTimeString();
  });
  const values = rows.map(r => Number(r[COL_VALUE]));

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("trendChart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: `Value（直近 ${rangeHours}h）`,
        data: values,
        tension: 0.28,
        pointRadius: 0,          // 点を消して見やすく
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "top" },
        tooltip: { mode: "index", intersect: false }
      },
      interaction: { mode: "index", intersect: false },
      scales: {
        x: {
          ticks: { maxTicksLimit: 10 },
          grid: { color: "rgba(0,0,0,0.05)" }
        },
        y: {
          grid: { color: "rgba(0,0,0,0.05)" }
        }
      }
    }
  });

  document.getElementById("trendTitle").textContent = `トレンド（直近 ${rangeHours}h）`;
  document.getElementById("trendBadge").textContent = `${rows.length} points`;
}

/* ---------- controls ---------- */
function setRange(h) {
  rangeHours = h;
  ["btn1h","btn6h","btn24h"].forEach(id => document.getElementById(id).classList.remove("active"));
  document.getElementById(`btn${h}h`).classList.add("active");
  refreshAll();
}

async function refreshAll() {
  const device = document.getElementById("deviceSelect").value;
  if (!device) return;

  setStatus("更新中...");
  try {
    const latest = await fetchLatest(device);
    renderLatest(latest);

    const trend = await fetchTrend(device);
    renderChart(trend);

    setStatus(`更新: ${new Date().toLocaleString()}`);
  } catch (e) {
    console.error(e);
    setStatus(`エラー: ${e.message}`);
  }
}

/* ---------- init ---------- */
async function init() {
  setStatus("初期化中...");

  // デバイス一覧
  const devices = await fetchDevices();
  const sel = document.getElementById("deviceSelect");
  sel.innerHTML = devices.map(d => `<option value="${d}">${d}</option>`).join("");
  sel.addEventListener("change", refreshAll);

  // 初期レンジ
  document.getElementById("btn24h").classList.add("active");

  // 自動更新表示
  document.getElementById("autoInfo").textContent = `${AUTO_REFRESH_MINUTES}分ごと`;

  await refreshAll();

  // ① 自動更新
  setInterval(refreshAll, AUTO_REFRESH_MS);
}

init();
</script>
</body>
</html>
